<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Day Tracker & Scheduler</title>

    <!-- Dynamic Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏳</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            50: '#fafafa',
                            100: '#f5f5f5',
                            200: '#e5e5e5',
                            300: '#d4d4d4',
                            400: '#a3a3a3',
                            500: '#737373',
                            600: '#525252',
                            700: '#404040',
                            800: '#262626',
                            900: '#171717',
                        },
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        active: {
                            500: '#22c55e',
                            600: '#16a34a',
                            glow: 'rgba(34, 197, 94, 0.5)'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-image 0.5s ease;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }
        .time-font { font-family: 'JetBrains Mono', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(156, 163, 175, 0.5); border-radius: 4px; }

        /* Smooth transitions */
        .schedule-item { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Active Pulse */
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        .active-now {
            animation: pulse-border 2s infinite;
            border-left: 4px solid #22c55e !important;
        }

        /* Mobile safe area */
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* Editable Title */
        [contenteditable]:focus {
            outline: 2px solid #0ea5e9;
            border-radius: 4px;
            padding: 0 4px;
            background: rgba(255,255,255,0.1);
        }

        /* Artistic Backgrounds (Unsplash) */
        .theme-bg-0 { background-color: #f3f4f6; background-image: none; } /* Default Simple */
        .dark .theme-bg-0 { background-color: #111827; background-image: none; }

        .theme-bg-1 { background-image: url('https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&w=1920&q=80'); } /* Misty Mountains */
        .theme-bg-2 { background-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?auto=format&fit=crop&w=1920&q=80'); } /* Deep Space */
        .theme-bg-3 { background-image: url('https://images.unsplash.com/photo-1547891654-e66ed7ebb968?auto=format&fit=crop&w=1920&q=80'); } /* Abstract Paint */
        .theme-bg-4 { background-image: url('https://images.unsplash.com/photo-1448375240586-dfd8d395ea6c?auto=format&fit=crop&w=1920&q=80'); } /* Deep Forest */
        .theme-bg-5 { background-image: url('https://images.unsplash.com/photo-1519608487953-e999c86e7455?auto=format&fit=crop&w=1920&q=80'); } /* City Night */
        .theme-bg-6 { background-image: url('https://images.unsplash.com/photo-1509316975850-ff9c5deb0cd9?auto=format&fit=crop&w=1920&q=80'); } /* Desert Dunes */
        .theme-bg-7 { background-image: url('https://images.unsplash.com/photo-1505118380757-91f5f5632de0?auto=format&fit=crop&w=1920&q=80'); } /* Ocean */
        .theme-bg-8 { background-image: url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?auto=format&fit=crop&w=1920&q=80'); } /* Geometric Dark */
        .theme-bg-9 { background-image: url('https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?auto=format&fit=crop&w=1920&q=80'); } /* Japan Sakura */
        .theme-bg-10 { background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?auto=format&fit=crop&w=1920&q=80'); } /* Liquid Oil */

        /* Glassmorphism utility - Increased opacity for better readability on images */
        .glass-panel {
            background: rgba(255, 255, 255, 0.90);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        .dark .glass-panel {
            background: rgba(17, 24, 39, 0.85); /* Darker opacity for dark mode readability */
        }
    </style>
</head>
<body id="app-body" class="theme-bg-0 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col transition-all duration-500">

    <!-- Header -->
    <header class="sticky top-0 z-40 glass-panel border-b border-gray-200/50 dark:border-gray-700/50 shadow-sm">
        <!-- Added 'relative' here to act as positioning context for the menu -->
        <div class="relative max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 overflow-hidden">
                <div class="w-9 h-9 rounded-xl bg-brand-600 flex items-center justify-center text-white shadow-lg shadow-brand-500/30">
                    <i class="fa-solid fa-clock text-lg"></i>
                </div>
                <!-- Editable Title -->
                <div class="flex flex-col">
                    <h1 id="app-title" contenteditable="true" spellcheck="false"
                        class="font-bold text-lg tracking-tight leading-none px-1 border border-transparent hover:border-gray-300 dark:hover:border-gray-600 rounded transition-colors truncate max-w-[150px] sm:max-w-none"
                        onblur="saveAppTitle()">TimeTrack</h1>
                    <span class="text-[10px] text-gray-500 font-medium px-1 uppercase tracking-wider">Tap name to edit</span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <!-- Desktop Date/Clock Display -->
                <div id="ist-clock-container" class="hidden sm:flex flex-col items-end leading-tight mr-2">
                    <span id="header-date" class="text-xs font-semibold text-gray-500 dark:text-gray-400">Fri, 28 Nov</span>
                    <span id="ist-clock" class="time-font text-sm font-bold text-brand-700 dark:text-brand-400">--:-- IST</span>
                </div>

                <!-- Theme Button -->
                <button onclick="toggleThemeModal()" class="p-2.5 rounded-xl text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Change Theme">
                    <i class="fa-solid fa-palette text-lg"></i>
                </button>

                <!-- Menu Dropdown Trigger -->
                <button onclick="toggleMenu()" class="p-2.5 rounded-xl text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i class="fa-solid fa-bars text-lg"></i>
                </button>
            </div>

            <!-- Mobile/Compact Menu (Moved INSIDE relative container for correct positioning) -->
            <div id="app-menu" class="hidden absolute right-4 top-16 w-56 glass-panel rounded-2xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 overflow-hidden transform origin-top-right transition-all z-50">
                <div class="p-1.5 space-y-1">
                    <button onclick="toggleDarkMode()" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-700/80 rounded-xl flex items-center gap-3 font-medium transition-colors">
                        <i class="fa-solid fa-circle-half-stroke w-4"></i> Toggle Dark Mode
                    </button>
                    <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                    <button onclick="exportData()" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-700/80 rounded-xl flex items-center gap-3 font-medium transition-colors">
                        <i class="fa-solid fa-file-arrow-down w-4"></i> Export JSON
                    </button>
                    <button onclick="document.getElementById('import-file').click()" class="w-full text-left px-4 py-2.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-700/80 rounded-xl flex items-center gap-3 font-medium transition-colors">
                        <i class="fa-solid fa-file-arrow-up w-4"></i> Import JSON
                    </button>
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                    <div class="h-px bg-gray-200 dark:bg-gray-700 my-1"></div>
                    <button onclick="shareConfig()" class="w-full text-left px-4 py-2.5 text-sm text-brand-600 dark:text-brand-400 font-bold hover:bg-brand-50 dark:hover:bg-gray-700/80 rounded-xl flex items-center gap-3 transition-colors">
                        <i class="fa-solid fa-share-nodes w-4"></i> Share URL
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Theme Selector Modal -->
    <div id="theme-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm hidden items-center justify-center z-50 p-4 animate-fade-in">
        <div class="glass-panel w-full max-w-lg rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col max-h-[80vh]">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-lg font-bold">Select Background</h2>
                <button onclick="toggleThemeModal()" class="w-8 h-8 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center transition-colors">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="p-6 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 gap-3">
                <!-- Theme options generated by JS -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-3xl mx-auto w-full p-4 safe-bottom">

        <!-- Mobile Clock (Visible only on small screens) -->
        <div class="sm:hidden mb-6 text-center glass-panel rounded-2xl py-3 border border-gray-200/50 dark:border-gray-700/50">
            <div id="mobile-date" class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">FRI, 28 NOV</div>
            <div class="flex items-baseline justify-center gap-1.5">
                <span id="ist-clock-mobile" class="time-font text-3xl font-bold text-gray-800 dark:text-white">--:--</span>
                <span class="text-xs font-bold text-brand-600 dark:text-brand-400 bg-brand-50 dark:bg-brand-900/50 px-1.5 py-0.5 rounded">IST</span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="grid grid-cols-4 gap-2 mb-6 glass-panel p-1.5 rounded-xl border border-gray-200/50 dark:border-gray-700/50 shadow-sm">
            <button onclick="switchTab('WFH')" id="tab-WFH" class="tab-btn py-2.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-center">WFH</button>
            <button onclick="switchTab('Office')" id="tab-Office" class="tab-btn py-2.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-center">Office</button>
            <button onclick="switchTab('Saturday')" id="tab-Saturday" class="tab-btn py-2.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-center">Sat</button>
            <button onclick="switchTab('Sunday')" id="tab-Sunday" class="tab-btn py-2.5 text-xs sm:text-sm font-medium rounded-lg transition-all text-center">Sun</button>
        </div>

        <!-- Schedule List -->
        <div id="schedule-container" class="space-y-3 pb-24">
            <!-- Dynamic Content Here -->
        </div>

    </main>

    <!-- Floating Action Button -->
    <button onclick="openModal()" class="fixed bottom-6 right-6 w-14 h-14 bg-brand-600 hover:bg-brand-500 text-white rounded-full shadow-xl shadow-brand-500/40 flex items-center justify-center transition-transform hover:scale-105 active:scale-95 z-30">
        <i class="fa-solid fa-plus text-xl"></i>
    </button>

    <!-- Add/Edit Modal Form -->
    <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-end sm:items-center justify-center z-50 p-0 sm:p-4">
        <div class="bg-white dark:bg-gray-800 w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl shadow-2xl transform transition-all flex flex-col max-h-[90vh] border border-gray-200 dark:border-gray-700">

            <!-- Modal Header -->
            <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800 rounded-t-2xl">
                <h2 class="text-lg font-bold" id="modal-title">Add Schedule</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fa-solid fa-times text-lg"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto">
                <form id="schedule-form" onsubmit="saveSchedule(event)">
                    <input type="hidden" id="edit-id">

                    <div class="space-y-5">
                        <!-- Icon Selector -->
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-3">Select Icon</label>
                            <div class="grid grid-cols-6 gap-2" id="icon-grid">
                                <!-- Generated by JS -->
                            </div>
                            <input type="hidden" id="selected-icon" value="fa-briefcase">
                        </div>

                        <!-- Name -->
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Activity Name</label>
                            <input type="text" id="task-name" required placeholder="e.g. Focus Time"
                                class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 focus:outline-none transition-shadow font-medium">
                        </div>

                        <!-- Time -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">Start Time</label>
                                <input type="time" id="start-time" required
                                    class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 focus:outline-none time-font font-medium">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1.5">End Time</label>
                                <input type="time" id="end-time" required
                                    class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 focus:outline-none time-font font-medium">
                            </div>
                        </div>

                        <div id="form-error" class="hidden flex items-center gap-2 text-red-500 text-sm bg-red-50 dark:bg-red-900/20 p-3 rounded-lg border border-red-200 dark:border-red-800">
                            <i class="fa-solid fa-circle-exclamation"></i>
                            <span id="error-text">Error message</span>
                        </div>
                    </div>

                    <div class="mt-8 flex gap-3">
                        <button type="button" onclick="deleteSchedule()" id="btn-delete" class="hidden flex-1 bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400 py-3.5 rounded-xl font-bold transition-colors">
                            Delete
                        </button>
                        <button type="submit" class="flex-[2] bg-brand-600 hover:bg-brand-500 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-brand-500/30 transition-all transform active:scale-95">
                            Save Activity
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-gray-800 dark:bg-white text-white dark:text-gray-900 px-6 py-3 rounded-full shadow-2xl font-medium text-sm opacity-0 transition-all duration-300 pointer-events-none z-50 whitespace-nowrap scale-90">
        Message
    </div>

    <!-- Javascript Logic -->
    <script>
        // --- Configuration & Constants ---
        const THEMES = [
            { id: 0, name: 'Default Clean' },
            { id: 1, name: 'Misty Peaks' },
            { id: 2, name: 'Deep Space' },
            { id: 3, name: 'Abstract Art' },
            { id: 4, name: 'Deep Forest' },
            { id: 5, name: 'Cyber City' },
            { id: 6, name: 'Desert Dunes' },
            { id: 7, name: 'Open Ocean' },
            { id: 8, name: 'Dark Geometry' },
            { id: 9, name: 'Kyoto Sakura' },
            { id: 10, name: 'Liquid Oil' }
        ];

        const ICONS = [
            'fa-briefcase', 'fa-laptop-code', 'fa-mug-hot', 'fa-utensils',
            'fa-bed', 'fa-car', 'fa-phone', 'fa-users',
            'fa-dumbbell', 'fa-book', 'fa-gamepad', 'fa-music',
            'fa-cart-shopping', 'fa-house', 'fa-plane', 'fa-stethoscope'
        ];

        // --- State Management ---
        let activeTab = 'WFH';
        let appState = {
            title: 'TimeTrack',
            themeId: 0,
            schedules: {
                'WFH': [],
                'Office': [],
                'Saturday': [],
                'Sunday': []
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initIcons();
            initThemeSelector();

            // Handle Data Import (URL or Local)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('data')) {
                loadFromUrl(urlParams.get('data'));
            } else {
                loadLocalData();
            }

            // Set Title & Theme UI
            document.getElementById('app-title').textContent = appState.title;
            applyTheme(appState.themeId);
            loadDarkMode();

            render();

            // Timer for Clock & Highlight
            setInterval(updateTimeAndStatus, 1000);
            updateTimeAndStatus();
        });

        // --- Core Functions ---

        function updateTimeAndStatus() {
            // Get IST Time
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const istOffset = 5.5 * 60 * 60000;
            const istDate = new Date(utc + istOffset);

            // Time Formatting
            const hours = String(istDate.getHours()).padStart(2, '0');
            const minutes = String(istDate.getMinutes()).padStart(2, '0');
            const currentTimeStr = `${hours}:${minutes}`;
            const currentSeconds = istDate.getSeconds();

            // Date Formatting
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const dayName = days[istDate.getDay()];
            const dayNum = istDate.getDate();
            const monthName = months[istDate.getMonth()];

            const dateStrShort = `${dayName}, ${dayNum} ${monthName}`;
            const dateStrFull = `${dayName}, ${dayNum} ${monthName}`; // Can extend if needed

            // Update UI
            document.getElementById('ist-clock').textContent = `${currentTimeStr} IST`;
            document.getElementById('ist-clock-mobile').textContent = currentTimeStr;
            document.getElementById('header-date').textContent = `${dateStrShort} • `;
            document.getElementById('mobile-date').textContent = dateStrFull;

            // Highlight Logic
            const list = appState.schedules[activeTab];
            let activeFound = false;

            if(!list) return;

            list.forEach(item => {
                const el = document.getElementById(`task-${item.id}`);
                if (!el) return;

                const startMins = timeToMins(item.start);
                const endMins = timeToMins(item.end);
                const currentMins = timeToMins(currentTimeStr);

                const statusArea = el.querySelector('.status-indicator');
                const timeLeftEl = el.querySelector('.time-left');
                const progressBar = el.querySelector('.progress-bar');

                // Reset styles
                el.classList.remove('active-now', 'opacity-50');
                statusArea.classList.add('hidden');

                if (currentMins >= startMins && currentMins < endMins) {
                    // Active Task
                    activeFound = true;
                    el.classList.add('active-now');
                    statusArea.classList.remove('hidden');

                    const totalDuration = endMins - startMins;
                    const elapsed = currentMins - startMins;
                    const remaining = endMins - currentMins;

                    const percent = Math.min(100, Math.max(0, ((elapsed * 60 + currentSeconds) / (totalDuration * 60)) * 100));

                    // Updated to green classes dynamically or via style
                    progressBar.style.width = `${percent}%`;
                    progressBar.classList.add('bg-active-500'); // Ensure green
                    timeLeftEl.textContent = `${remaining} min remaining`;
                    timeLeftEl.classList.add('text-active-600');

                } else if (currentMins >= endMins) {
                    // Past Task
                    el.classList.add('opacity-50'); // Dim completed
                }
            });
        }

        function switchTab(day) {
            activeTab = day;
            render();
            updateTimeAndStatus();
        }

        function render() {
            // Update Tab UI
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const id = btn.id.replace('tab-', '');
                if (id === activeTab) {
                    btn.className = 'tab-btn flex-1 py-2.5 text-xs sm:text-sm font-bold rounded-lg text-brand-600 bg-white dark:bg-gray-800 shadow-md ring-1 ring-black/5 dark:ring-white/5 transition-all transform scale-105';
                } else {
                    btn.className = 'tab-btn flex-1 py-2.5 text-xs sm:text-sm font-medium rounded-lg text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-all';
                }
            });

            // Render List
            const container = document.getElementById('schedule-container');
            const list = appState.schedules[activeTab] || [];
            list.sort((a, b) => a.start.localeCompare(b.start));

            if (list.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-24 text-gray-400 dark:text-gray-500 select-none glass-panel rounded-2xl mx-4">
                        <i class="fa-solid fa-mug-hot text-5xl mb-4 opacity-30"></i>
                        <p class="font-medium text-lg">Free Day!</p>
                        <p class="text-sm opacity-70">No tasks scheduled for ${activeTab}</p>
                    </div>`;
                return;
            }

            container.innerHTML = list.map(item => {
                const duration = calculateDuration(item.start, item.end);
                return `
                <div onclick="editSchedule('${item.id}')" id="task-${item.id}"
                    class="schedule-item relative glass-panel rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700/50 cursor-pointer hover:shadow-lg hover:translate-y-[-2px] group">

                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-brand-50 dark:bg-gray-700 text-brand-600 dark:text-brand-400 flex items-center justify-center shrink-0 shadow-sm">
                            <i class="fa-solid ${item.icon} text-xl"></i>
                        </div>

                        <div class="flex-grow">
                            <h3 class="font-bold text-gray-800 dark:text-gray-100 leading-tight">${item.title}</h3>
                            <div class="flex items-center gap-3 mt-1.5 text-sm text-gray-500 dark:text-gray-400">
                                <span class="time-font font-medium bg-gray-100 dark:bg-gray-700/80 px-2 py-0.5 rounded-md text-xs tracking-wide">${formatTimeDisplay(item.start)} - ${formatTimeDisplay(item.end)}</span>
                                <span class="text-xs opacity-60 font-medium"> ${duration}</span>
                            </div>
                        </div>

                        <div class="text-xs text-gray-400 group-hover:text-brand-500 transition-colors opacity-0 group-hover:opacity-100">
                            <i class="fa-solid fa-pen text-lg"></i>
                        </div>
                    </div>

                    <!-- Progress/Status Area -->
                    <div class="status-indicator mt-4 hidden animate-fade-in">
                        <div class="flex justify-between text-[10px] uppercase tracking-wider font-bold text-active-600 mb-1.5">
                            <span class="status-text"><i class="fa-solid fa-circle-play mr-1"></i>Now Active</span>
                            <span class="time-left"></span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden">
                            <div class="progress-bar bg-active-500 h-1.5 rounded-full shadow-[0_0_10px_rgba(34,197,94,0.6)]" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            updateTimeAndStatus();
        }

        // --- Data Persistence (Updated for V2) ---

        function saveLocalData() {
            localStorage.setItem('scheduleApp_v2', JSON.stringify(appState));
        }

        function loadLocalData() {
            const saved = localStorage.getItem('scheduleApp_v2');
            // Check for v2 data first
            if (saved) {
                appState = JSON.parse(saved);
            } else {
                // Check for v1 data (legacy support)
                const v1 = localStorage.getItem('scheduleData');
                if (v1) {
                    appState.schedules = JSON.parse(v1);
                    saveLocalData();
                }
            }
        }

        function loadFromUrl(base64Data) {
            try {
                const decoded = JSON.parse(decodeURIComponent(atob(base64Data)));
                // Handle V2 vs V1 format
                if (decoded.schedules) {
                    appState = decoded; // V2
                } else {
                    appState.schedules = decoded; // V1
                }
                showToast('Configuration loaded!');
                window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
                saveLocalData();
            } catch (e) {
                showToast('Invalid data link');
                loadLocalData();
            }
        }

        // --- Themes ---

        function initThemeSelector() {
            const container = document.querySelector('#theme-modal .grid');
            container.innerHTML = THEMES.map(t => `
                <div onclick="applyTheme(${t.id}); saveLocalData(); toggleThemeModal()"
                    class="cursor-pointer group relative rounded-xl overflow-hidden aspect-video shadow-sm hover:shadow-md transition-all border border-gray-200 dark:border-gray-600">
                    <div class="absolute inset-0 theme-bg-${t.id}"></div>
                    <div class="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity">
                        <span class="text-white font-bold text-xs shadow-black drop-shadow-md">${t.name}</span>
                    </div>
                    ${appState.themeId === t.id ? '<div class="absolute top-1 right-1 bg-white text-green-600 rounded-full w-5 h-5 flex items-center justify-center shadow-sm"><i class="fa-solid fa-check text-xs"></i></div>' : ''}
                </div>
            `).join('');
        }

        function applyTheme(id) {
            appState.themeId = id;
            const body = document.getElementById('app-body');
            // Remove existing theme classes
            body.className = body.className.replace(/theme-bg-\d+/g, '');
            body.classList.add(`theme-bg-${id}`);

            // Re-init selector to show active checkmark
            initThemeSelector();
        }

        function toggleThemeModal() {
            const modal = document.getElementById('theme-modal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            } else {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        // --- App Title ---

        function saveAppTitle() {
            const el = document.getElementById('app-title');
            const newTitle = el.textContent.trim();
            if (newTitle) {
                appState.title = newTitle;
                saveLocalData();
            } else {
                el.textContent = appState.title; // Revert if empty
            }
        }

        // --- Standard Logic (Modals, Forms, etc) ---

        function saveSchedule(e) {
            e.preventDefault();
            const id = document.getElementById('edit-id').value;
            const title = document.getElementById('task-name').value.trim();
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            const icon = document.getElementById('selected-icon').value;
            const errorDiv = document.getElementById('form-error');
            const errorText = document.getElementById('error-text');

            if (start >= end) {
                errorText.textContent = "End time must be after start time";
                errorDiv.classList.remove('hidden');
                return;
            }

            // Overlap Check
            const startMins = timeToMins(start);
            const endMins = timeToMins(end);

            const hasOverlap = appState.schedules[activeTab].some(item => {
                if (id && item.id === id) return false;
                const iStart = timeToMins(item.start);
                const iEnd = timeToMins(item.end);
                return (startMins < iEnd && endMins > iStart);
            });

            if (hasOverlap) {
                errorText.textContent = "Overlaps with existing task";
                errorDiv.classList.remove('hidden');
                return;
            }

            if (id) {
                const index = appState.schedules[activeTab].findIndex(x => x.id === id);
                if (index !== -1) appState.schedules[activeTab][index] = { id, title, start, end, icon };
            } else {
                const newId = Date.now().toString(36) + Math.random().toString(36).substr(2);
                appState.schedules[activeTab].push({ id: newId, title, start, end, icon });
            }

            saveLocalData();
            closeModal();
            render();
            showToast('Schedule saved successfully');
        }

        function deleteSchedule() {
            const id = document.getElementById('edit-id').value;
            if (id && confirm('Delete this activity?')) {
                appState.schedules[activeTab] = appState.schedules[activeTab].filter(item => item.id !== id);
                saveLocalData();
                closeModal();
                render();
                showToast('Activity deleted');
            }
        }

        function openModal(editId = null) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            const form = document.getElementById('schedule-form');
            const deleteBtn = document.getElementById('btn-delete');
            const errorDiv = document.getElementById('form-error');

            errorDiv.classList.add('hidden');
            form.reset();

            if (!editId) {
                const now = new Date();
                const minutes = Math.ceil(now.getMinutes() / 30) * 30;
                now.setMinutes(minutes);
                document.getElementById('start-time').value = now.toTimeString().substring(0,5);
            }

            if (editId) {
                title.textContent = "Edit Activity";
                deleteBtn.classList.remove('hidden');
                const item = appState.schedules[activeTab].find(i => i.id === editId);
                document.getElementById('edit-id').value = item.id;
                document.getElementById('task-name').value = item.title;
                document.getElementById('start-time').value = item.start;
                document.getElementById('end-time').value = item.end;
                selectIcon(item.icon);
            } else {
                title.textContent = "New Activity";
                deleteBtn.classList.add('hidden');
                document.getElementById('edit-id').value = "";
                selectIcon('fa-briefcase');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        function editSchedule(id) { openModal(id); }

        function initIcons() {
            document.getElementById('icon-grid').innerHTML = ICONS.map(icon => `
                <button type="button" onclick="selectIcon('${icon}')"
                    class="icon-option aspect-square rounded-xl border border-gray-200 dark:border-gray-700 flex items-center justify-center hover:bg-brand-50 dark:hover:bg-gray-700 transition-all"
                    data-icon="${icon}">
                    <i class="fa-solid ${icon} text-gray-400"></i>
                </button>
            `).join('');
        }

        function selectIcon(icon) {
            document.getElementById('selected-icon').value = icon;
            document.querySelectorAll('.icon-option').forEach(btn => {
                if (btn.dataset.icon === icon) {
                    btn.className = 'icon-option aspect-square rounded-xl border-2 border-brand-500 bg-brand-50 dark:bg-brand-900/30 flex items-center justify-center text-brand-600 dark:text-brand-400 scale-105 shadow-sm';
                    btn.querySelector('i').className = `fa-solid ${icon}`;
                } else {
                    btn.className = 'icon-option aspect-square rounded-xl border border-gray-200 dark:border-gray-700 flex items-center justify-center hover:bg-gray-50 dark:hover:bg-gray-800 text-gray-400';
                    btn.querySelector('i').className = `fa-solid ${btn.dataset.icon}`;
                }
            });
        }

        // --- Utils ---
        function timeToMins(t) { const [h, m] = t.split(':').map(Number); return h * 60 + m; }

        function calculateDuration(start, end) {
            let diff = timeToMins(end) - timeToMins(start);
            const h = Math.floor(diff / 60);
            const m = diff % 60;
            return `${h > 0 ? h + 'h ' : ''}${m}m`;
        }

        function formatTimeDisplay(t) {
            const [h, m] = t.split(':');
            let hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12;
            hour = hour ? hour : 12;
            return `${hour}:${m} ${ampm}`;
        }

        function toggleMenu() {
            const menu = document.getElementById('app-menu');
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                setTimeout(() => menu.style.opacity = 1, 10);
            } else {
                menu.classList.add('hidden');
                menu.style.opacity = 0;
            }
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.themeMode = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.themeMode = 'dark';
            }
            toggleMenu();
        }

        function loadDarkMode() {
            if (localStorage.themeMode === 'dark' || (!('themeMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.style.opacity = '1';
            toast.classList.remove('scale-90');
            toast.classList.add('scale-100');
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.classList.remove('scale-100');
                toast.classList.add('scale-90');
            }, 3000);
        }

        function shareConfig() {
            const json = JSON.stringify(appState);
            const encoded = btoa(encodeURIComponent(json));
            const url = `${window.location.origin}${window.location.pathname}?data=${encoded}`;

            const temp = document.createElement("input");
            document.body.appendChild(temp);
            temp.value = url;
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);

            showToast('Full setup (Theme + Schedule) copied!');
            toggleMenu();
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appState));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `TimeTrack_${Date.now()}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            toggleMenu();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.schedules) {
                        appState = imported; // V2 Import
                    } else if (imported.WFH) {
                        appState.schedules = imported; // V1 Import
                    } else {
                        throw new Error("Unknown format");
                    }
                    saveLocalData();
                    document.getElementById('app-title').textContent = appState.title;
                    applyTheme(appState.themeId || 0);
                    render();
                    showToast('Import successful');
                } catch(err) {
                    showToast('Invalid file format');
                }
            };
            reader.readAsText(file);
            toggleMenu();
        }
    </script>
</body>
</html>
